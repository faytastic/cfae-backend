name: Backend Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.CFAE_BACKEND_DEPLOY_KEY }}" > ~/.ssh/cfae_deploy_key
          chmod 600 ~/.ssh/cfae_deploy_key

          echo "Host cfae-vm
            HostName 129.80.115.29
            User opc
            IdentityFile ~/.ssh/cfae_deploy_key
            StrictHostKeyChecking no" >> ~/.ssh/config

   
      - name: Install systemd service
        run: |
          scp server/cfae-backend.service cfae-vm:/tmp/cfae-backend.service
          ssh cfae-vm "
            sudo mv /tmp/cfae-backend.service /etc/systemd/system/cfae-backend.service &&
            sudo systemctl daemon-reload &&
            sudo systemctl enable cfae-backend
          "

      - name: Deploy backend with rollback
        run: |
          ssh cfae-vm "
            set -e

            cd /home/opc/cfae-backend

            echo 'Recording current commit'
            CURRENT_COMMIT=\$(git rev-parse HEAD)

            if [ -f .last_known_good_commit ]; then
              PREVIOUS_COMMIT=\$(cat .last_known_good_commit)
            else
              PREVIOUS_COMMIT=\$CURRENT_COMMIT
            fi

            echo 'Fetching latest code'
            git fetch origin
            git checkout main
            git reset --hard origin/main

            echo 'Restarting backend'
            sudo systemctl restart cfae-backend
            sleep 5

            echo 'Checking /health'
            if curl -fs http://127.0.0.1:5000/health; then
              NEW_COMMIT=\$(git rev-parse HEAD)
              echo \$NEW_COMMIT > .last_known_good_commit
              echo 'Deploy succeeded'
            else
              echo 'Health check failed, rolling back'

              git checkout \$PREVIOUS_COMMIT
              sudo systemctl restart cfae-backend
              sleep 5

              echo 'Re-checking /health after rollback'
              curl -fs http://127.0.0.1:5000/health

              exit 1
            fi
          "
